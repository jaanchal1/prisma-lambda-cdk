# Redis-OM Lambda CDK Sample Application

This sample shows how to define a Lambda function which uses [Redis-om](https://github.com/redis/redis-om-node) via AWS Cloud Development Kit. This is a fork of [prisma-lambda-cdk](https://github.com/aws-samples/prisma-lambda-cdk/) sample repo which replaces mysql/postgres with redis stack & prisma with Redis-om.

Redis OM is an open source object mapping, search etc library for Redis written in Typescript & very useful with its developer friendly API.

By this sample, you can see how a Lambda function which uses Redis OM can be deployed with CDK, how indexes can be created from Lambda, and how Redis OM works in Lambda.

### Lambda Dashboard

![AWS Lambda console output](https://github.com/jaanchal1/redis-om-lambda-cdk/raw/main/img/aws-console-lambda.png)

<!-- # Overview video (Optional)

Here's a short video that explains the project and how it uses Redis:

[Insert your own video here, and remove the one below]

[![Embed your YouTube video](https://i.ytimg.com/vi/vyxdC1qK4NE/maxresdefault.jpg)](https://www.youtube.com/watch?v=vyxdC1qK4NE) -->

## How it works

### Architecture

This sample consists of the following AWS services:

- Amazon VPC
- Redis Cloud (Amazon doesn't offer redis stack yet)
- AWS Lambda

There're two Lambda functions:

1. a function that reads and writes records from/to Redis [`handler.ts`](backend/handler.ts)
2. a function that sets up the index for Request entity [`migration-runner.ts`](backend/migration-runner.ts)

### How the data is stored:

#### Database Schema

```ts
class Request extends Entity {
  public awsRequestId: string;
  public createdAt: Date;
}
```

The Request data is stored in JSON format using RedisJSON component where each entry contains the following values:

- `awsRequestId`: unique request id generated by aws
- `createdAt`: Timestamp when this request was received

It uses the `repository.createAndSave()` function which internally uses `JSON.SET` command.
Code Example:

```ts
requestRepository.createAndSave({
  awsRequestId: context.awsRequestId,
  createdAt: new Date(),
});
```

### How the data is accessed:

- The request data is accessed via `Request:{entityId}` key. RedisSearch module is used to fetch the data from Redis.

It uses the `repository.search.all()` function which internally uses `FT.SEARCH` command.
Code Example:

```ts
requestRepository.search().all();
```

### Performance Benchmarks

[If you migrated an existing app to use Redis, please put performance benchmarks here to show the performance improvements.]

## How to run it locally?

### Prerequisites

- NodeJs - V16
- Docker
- AWS SDK

### Local installation

- Setup aws CDK by following [this guide](https://docs.aws.amazon.com/cdk/v2/guide/getting_started.html)
- copy .env.example & add the REDIS_URI to it

```bash
cp .env.example .env
```

- Install dependencies using npm

```bash
npm ci
```

- Deploy the Lambda function using cdk

```bash
npx cdk deploy --require-approval never
```

![CDK deploy output](https://github.com/jaanchal1/redis-om-lambda-cdk/raw/main/img/cdk-deploy-output.png)

- Take note of the output generated by the above function so that we can use them to test the lambda functions

1. `RedisOmLambdaCdkStack.ApplicationHandlerLambdaArn*`
2. `RedisOmLambdaCdkStack.ApplicationMigrationRunnerLambdaArn*`

- Create the search index

```bash
aws lambda invoke --function-name ApplicationMigrationRunnerLambdaArn response.json
# replace the `ApplicationMigrationRunnerLambdaArn` with actual ARN you wrote down in the previous step
```

- Creating Records

```bash
aws lambda invoke --function-name ApplicationHandlerLambdaArn response.json
# Replace the `ApplicationHandlerLambdaArn` with actual ARN you wrote down in the previous step
```

- Fetching Records

```bash
aws lambda invoke --function-name ApplicationHandlerLambdaArn --payload eyJjb21tYW5kIjoiZ2V0In0= response.json
# Replace the `ApplicationHandlerLambdaArn` with actual ARN you wrote down in the previous step
# Check response.json to see the records you created
```
